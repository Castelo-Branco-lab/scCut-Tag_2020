include: 'preflight'
include: 'snakefile_clustering'
include: 'snakefile_other_datasets'

rule all_integration:
  input:
    'results/integration/H3K4me3_RNA/H3K4me3_RNA_coembed.Rds',
    expand('results/{antibody}/integration/integrated.Rds',antibody = ['Rad21','Olig2']),
    'results/integration/histone_3active/histone_3active_integrated.Rds',
    'results/other_datasets/PCA/PCA_table_cell_lines.npz',
    'results/other_datasets/PCA/PCA_table_brain.npz',
    

####### H3K4me4 RNA integration
rule H3K4me3_Sten_integrate:
  input:
    'results/H3K4me3/clustering/01.clustering.Rds',
    'results/Sten_RNA/clustering/01.clustering_20000cells.Rds',
    notebook = os.path.dirname(workflow.basedir) + '/notebooks/integration/integration_H3K4me3_RNA.Rmd',
  output:
    'results/integration/H3K4me3_RNA/H3K4me3_RNA_coembed.Rds'
  params:
    report = CWD + '/results/integration/H3K4me3_RNA/H3K4me3_RNA_coembed.html',
    out_prefix = CWD + '/results/'
  shell:
    "Rscript -e \"rmarkdown::render(input='{input.notebook}',output_file = '{params.report}', params=list(out_prefix = '{params.out_prefix}'))\""

    
######## Olig2 and Rad21
rule integration_olig2_rad21:
  input:
    'results/{antibody}/clustering/01.clustering.Rds',
    'results/H3K27ac/clustering/01.clustering.Rds',
    notebook = os.path.dirname(workflow.basedir) + "/notebooks/{antibody}/Integration_H3K27ac.Rmd",
  output:
    'results/{antibody}/integration/integrated.Rds',
    directory('results/{antibody}/integration/bigwig/'),
  params:
    report         = CWD + '/results/{antibody}/integration/integrated.html',
    out_prefix     = CWD + '/results/'
  shell:
    "Rscript -e \"rmarkdown::render(input='{input.notebook}',output_file='{params.report}',params=list(out_prefix='{params.out_prefix}')) \""


###### Integration 3 active marks
rule integration_active:
  input:
    "results/H3K4me3/clustering/01.clustering.Rds",
    "results/H3K27ac/clustering/01.clustering.Rds",
    "results/H3K36me3/clustering/01.clustering.Rds",
    notebook = os.path.dirname(workflow.basedir) + "/notebooks/integration/integration_3active.Rmd",
  output:
    "results/integration/histone_3active/histone_3active_integrated.Rds",
  params:
    report     = CWD + "/results/integration/histone_3active/Histone_3active_integrated.html",
    out_prefix = CWD + "/results/"
  shell:
    "Rscript -e \"rmarkdown::render(input='{input.notebook}',output_file = '{params.report}', params=list(out_prefix = '{params.out_prefix}'))\" "



